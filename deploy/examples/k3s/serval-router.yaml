# serval-router Kubernetes Deployment
#
# Hardcoded routing to echo-backend for data plane testing.
# Routes: /api/* -> echo-backend, /static/* -> echo-backend, /* -> echo-backend
#
# Build:
#   zig build
#   docker build -f deploy/Dockerfile.router -t serval-router:latest .
#
# Deploy:
#   kubectl apply -f deploy/examples/echo-backend.yaml
#   kubectl apply -f deploy/serval-router.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: serval-router
    namespace: default
spec:
    replicas: 1
    selector:
        matchLabels:
            app: serval-router
    template:
        metadata:
            labels:
                app: serval-router
        spec:
            containers:
                - name: serval-router
                  image: serval-router:latest
                  imagePullPolicy: Never # Use local image
                  args:
                      - "--port"
                      - "8080"
                      - "--admin-port"
                      - "9901"
                      - "--api-backends"
                      - "echo-backend:8080"
                      - "--static-backends"
                      - "echo-backend:8080"
                      - "--debug"
                  ports:
                      - containerPort: 8080
                        name: http
                      - containerPort: 9901
                        name: admin
                  readinessProbe:
                      httpGet:
                          path: /readyz
                          port: 9901
                      initialDelaySeconds: 2
                      periodSeconds: 5
                  livenessProbe:
                      httpGet:
                          path: /healthz
                          port: 9901
                      initialDelaySeconds: 5
                      periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
    name: serval-router
    namespace: default
spec:
    type: LoadBalancer
    selector:
        app: serval-router
    ports:
        - name: http
          port: 80
          targetPort: 8080
        - name: admin
          port: 9901
          targetPort: 9901
