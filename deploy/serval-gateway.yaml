# serval-gateway Kubernetes Deployment
#
# Prerequisites:
#   kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml
#
# Deploy:
#   kubectl apply -f deploy/serval-gateway.yaml
---
apiVersion: v1
kind: ServiceAccount
metadata:
    name: serval-gateway
    namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
    name: serval-gateway
rules:
    # Gateway API resources - read access
    - apiGroups: ["gateway.networking.k8s.io"]
      resources: ["gatewayclasses", "gateways", "httproutes"]
      verbs: ["get", "list", "watch"]
    # Gateway API status subresources - write access for status updates
    - apiGroups: ["gateway.networking.k8s.io"]
      resources:
          ["gatewayclasses/status", "gateways/status", "httproutes/status"]
      verbs: ["get", "patch", "update"]
    # Core resources for resolution
    - apiGroups: [""]
      resources: ["services", "endpoints", "secrets"]
      verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
    name: serval-gateway
subjects:
    - kind: ServiceAccount
      name: serval-gateway
      namespace: default
roleRef:
    kind: ClusterRole
    name: serval-gateway
    apiGroup: rbac.authorization.k8s.io
---
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
    name: serval
spec:
    controllerName: serval.dev/gateway-controller
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: serval-gateway
    namespace: default
spec:
    replicas: 1
    selector:
        matchLabels:
            app: serval-gateway
    template:
        metadata:
            labels:
                app: serval-gateway
        spec:
            serviceAccountName: serval-gateway
            containers:
                - name: serval-gateway
                  image: serval-gateway:latest # Build with: docker build -t serval-gateway .
                  imagePullPolicy: Never # Use local image
                  ports:
                      - containerPort: 8080
                        name: admin
                  livenessProbe:
                      httpGet:
                          path: /healthz
                          port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 10
                  readinessProbe:
                      httpGet:
                          path: /readyz
                          port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
    name: serval-gateway
    namespace: default
spec:
    # ClusterIP for internal admin access only (health probes, metrics)
    # Gateway controller doesn't serve traffic - that's the router's job
    type: ClusterIP
    selector:
        app: serval-gateway
    ports:
        - name: admin
          port: 8080
          targetPort: 8080
